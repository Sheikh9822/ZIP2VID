name: ZIP to AV1 Video Generator

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'Direct URL to ZIP/CBZ file'
        required: true
        type: string
      filename:
        description: 'Output Filename (Leave empty for auto-detect)'
        required: false
        type: string
        default: ''
      aspect_ratio:
        description: 'Video Orientation'
        required: true
        type: choice
        options: 
          - 'Landscape (1920x1080)'
          - 'Portrait (1080x1920)'
          - 'Square (1080x1080)'
        default: 'Landscape (1920x1080)'
      img_duration:
        description: 'Seconds per Image (0.33 = 3 img/sec)'
        required: true
        default: '0.33'
        type: string
      crf:
        description: 'AV1 Quality (30-35 is standard)'
        required: true
        default: '32'
        type: string
      preset:
        description: 'SVT-AV1 Preset (8-12)'
        required: true
        default: '10'
        type: string

jobs:
  generate-video:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Calculate Name
        id: meta
        shell: bash
        run: |
          URL="${{ inputs.file_url }}"
          CUSTOM="${{ inputs.filename }}"
          
          if [[ -n "$CUSTOM" ]]; then
            NAME="$CUSTOM"
          elif [[ "$URL" == *"f="* ]]; then
            # Extract from ?f= parameter (used by Kemono/etc)
            NAME=$(echo "$URL" | sed -n 's/.*f=\([^&]*\).*/\1/p')
            NAME="${NAME%.*}" # Remove .zip/.cbz
          else
            # Standard URL path extraction
            CLEAN_URL="${URL%%?*}"
            NAME=$(basename "$CLEAN_URL")
            NAME="${NAME%.*}"
          fi
          
          # URL Decode (replaces %20 with spaces, etc)
          NAME=$(printf '%b' "${NAME//%/\\x}")
          
          # Sanitize: Remove characters not allowed in filenames
          NAME=$(echo "$NAME" | sed 's/[^a-zA-Z0-9._ -]/_/g')
          
          # Absolute Fallback if still empty
          if [[ -z "$NAME" ]]; then NAME="video_output"; fi
          
          echo "artifact_name=$NAME" >> $GITHUB_OUTPUT
          echo "Using Filename: $NAME"

      - name: Setup FFmpeg (AV1 Enabled)
        uses: shaka-project/setup-ffmpeg@v2
        with:
          version: '6.0'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install moviepy==1.0.3 pillow requests numpy decorator==4.4.2 imageio-ffmpeg tqdm

      - name: Process Video
        env:
          FILE_URL: ${{ inputs.file_url }}
          FILENAME: ${{ steps.meta.outputs.artifact_name }}
          ASPECT_RATIO: ${{ inputs.aspect_ratio }}
          IMG_DURATION: ${{ inputs.img_duration }}
          CRF: ${{ inputs.crf }}
          PRESET: ${{ inputs.preset }}
        run: python main.py

      - name: Upload Video
        # Use the ID 'meta' output
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: output/*.mp4
          retention-days: 7